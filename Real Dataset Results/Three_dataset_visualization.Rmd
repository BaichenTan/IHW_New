---
title: "Three_dataset_visualization"
output: pdf_document
date: "2025-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("IHWpaper")
library(tidyverse)
library("DESeq2")
library("dplyr")
library(IHWold)
source(file.path(getwd(), "/R/method_new_binning_admm.R"))
source(file.path(getwd(), "/R/ihw_convex.R"))
proteomics_file <- system.file("extdata/real_data",
                               "science_signaling.csv", package = "IHWpaper")

proteomics_df <- read.csv(proteomics_file, stringsAsFactors = F)

proteomics_df$pvalue <- rank(proteomics_df$p1, ties.method="first")*proteomics_df$p1/nrow(proteomics_df) 

data("airway", package = "airway")
dds <- DESeqDataSet(se = airway, design = ~ cell + dex) %>% DESeq
deRes <- as.data.frame(results(dds))

bottomly <- analyze_dataset("bottomly")
```

```{r, cache = F}
## =========================
##  Libraries & Setup
## =========================
library(microbenchmark)
library(readr)
library(ggplot2)

set.seed(123)
alph <- 0.10

## =========================
##  Data Preparation
## =========================

# 1) Proteomics (IHWpaper)
proteomics_file <- system.file("extdata/real_data",
                               "science_signaling.csv", package = "IHWpaper")
proteomics_df <- read.csv(proteomics_file, stringsAsFactors = FALSE)
# p-values as in your earlier code
proteomics_df$pvalue <- rank(proteomics_df$p1, ties.method = "first") *
                        proteomics_df$p1 / nrow(proteomics_df)

# 2) Airway (DESeq2)
data("airway", package = "airway")
dds <- DESeqDataSet(se = airway, design = ~ cell + dex) %>% DESeq()
deRes <- as.data.frame(results(dds))
airway_ok <- deRes %>%
  dplyr::select(pvalue, baseMean) %>%
  tidyr::drop_na()

# 3) Bottomly (IHWpaper)
# analyze_dataset("bottomly") returns a data.frame with pvalue & baseMean
bottomly <- analyze_dataset("bottomly")
bottomly_ok <- bottomly %>%
  dplyr::select(pvalue, baseMean) %>%
  tidyr::drop_na()

# Bundle for iteration
ds_list <- list(
  proteomics = list(p = proteomics_df$pvalue, x = proteomics_df$X..peptides),
  airway     = list(p = airway_ok$pvalue,     x = airway_ok$baseMean),
  bottomly   = list(p = bottomly_ok$pvalue,   x = bottomly_ok$baseMean)
)

## =========================
##  Method Wrappers
## =========================

fit_admm <- function(p, x) {
  ihw_binning_admm(p, x, alph,
      nbins = "auto",
      nfolds = 5L,
      admm = TRUE)
}

fit_old <- function(p, x, nbins = "auto") {
  IHWold:::ihwOld(p, x, alph,
                  nbins = nbins,
                  nfolds_internal = 4L)
}

methods <- list(
  IHW_ADMM = fit_admm,
  IHW_OLD  = fit_old
)

## =========================
##  Benchmark Helper
## =========================

bench_one_dataset <- function(p, x, nbins, dataset, times = 10L) {
  mb <- microbenchmark(
    IHW_ADMM = { fit_admm(p, x) },
    IHW_OLD  = { fit_old(p, x, nbins = nbins)  },
    times = 10,
    unit  = "ns"
  )

  as_tibble(mb) %>%
    group_by(expr) %>%
    summarise(
      n        = n(),
      median_ns = median(time) / 1e9,
      q25_ns    = quantile(time, 0.25) / 1e9,
      q75_ns    = quantile(time, 0.75) / 1e9,
      .groups   = "drop"
    ) %>%
    mutate(dataset = dataset) %>%
    relocate(dataset, expr)
}

## =========================
##  Output paths
## =========================

out_dir <- "ihw_results"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)

fname <- function(dataset, method, ext = c("rds","csv")) {
  ext <- match.arg(ext)
  file.path(out_dir, paste0(dataset, "__", method, ".", ext))
}

## =========================
##  Benchmark, Fit, Save
## =========================

all_timings   <- list()
all_summaries <- list()

for (dname in names(ds_list)) {
  p <- ds_list[[dname]]$p
  x <- ds_list[[dname]]$x
  stopifnot(is.numeric(p), is.numeric(x), length(p) == length(x))
  
  if (dname == "proteomics"){
    nbins = 2
  } else {
    nbins = "auto"
  }

  # 1) timings
  tb <- bench_one_dataset(p, x, nbins, dataset = dname, times = 10L)
  print(tb)
  all_timings[[dname]] <- tb

  # 2) run each method ONCE (outside benchmark) and save results + summary
  for (mname in names(methods)) {
    message("Fitting ", mname, " on ", dname, " ...")
    if (mname == "IHW_OLD"){
      fit <- methods[[mname]](p, x, nbins = nbins)
    } else{
      fit <- methods[[mname]](p, x)
    }

    # save full fitted object (RDS)
    saveRDS(fit, file = fname(dname, mname, "rds"))

    # small per-fit summary
    rejs <- IHW:::rejections(fit)
    sumdf <- tibble(
      dataset    = dname,
      method     = mname,
      alpha      = alph,
      n          = length(p),
      rejections = rejs
    )

    # save summary CSV
    write_csv(sumdf, file = fname(dname, mname, "csv"))

    all_summaries[[paste(dname, mname, sep="__")]] <- sumdf
  }
}

# Master tables
timings_master <- bind_rows(all_timings) %>% arrange(dataset, expr)
summary_master <- bind_rows(all_summaries) %>% arrange(dataset, method)

# Save master tables
write_csv(timings_master, file.path(out_dir, "timings_master.csv"))
write_csv(summary_master, file.path(out_dir, "summary_master.csv"))

# Print quick look
print(timings_master)
print(summary_master)

```

```{r}
## =========================
##  Optional: Visualization
## =========================

ggplot(timings_master, aes(x = dataset, y = median_ns, fill = expr)) +
  geom_col(position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = q25_ns, ymax = q75_ns),
                position = position_dodge(width = 0.7), width = 0.2) +
  labs(x = "Dataset", y = "Runtime (s)", fill = "Method",
       title = "IHW Binning vs IHW OLD: runtime by dataset (median with IQR)") +
  theme_minimal()
```

```{r}
library(dplyr)
library(tidyr)
library(readr)

# 1) Rejections: wide by method
rejs_wide <- summary_master %>%
  select(dataset, method, rejections) %>%
  mutate(method = recode(method,
                         IHW_OLD  = "Rejection Number Old IHW",
                         IHW_ADMM = "Rejection Number ADMM Binning")) %>%
  pivot_wider(names_from = method, values_from = rejections)

# 2) Median times (log): wide by method
times_wide <- timings_master %>%
  transmute(dataset,
            method = as.character(expr),
            # if your microbenchmark numbers are already in ms, this is log(ms);
            # use log10 or log as you prefer:
            log_median = log(median_ns)) %>%   # or log10(median_ms)
  mutate(method = recode(method,
                         IHW_OLD  = "Median run time of Old IHW (in log(s))",
                         IHW_ADMM = "Median run time of ADMM Binning (in log(s))")) %>%
  pivot_wider(names_from = method, values_from = log_median)

# 3) Final table: one row per dataset
final_table <- rejs_wide %>%
  left_join(times_wide, by = "dataset") %>%
  arrange(dataset)

final_table

```

## Weights Visualization
```{r}
## ==================== Libraries ====================
library(ggplot2)
library(dplyr)
library(cowplot)
library(IHW)
library(IHWold)
library(IHWpaper)
library(DESeq2)

## ---- your ADMM-binning implementation (adjust path) ----
source("~/Desktop/Columbia Stats PhD/Optimization (Nikos)/Optimization_New/R/method_new_binning_admm.R")

## ==================== Datasets ======================
# --- Proteomics ---
proteomics_file <- system.file("extdata/real_data", "science_signaling.csv", package = "IHWpaper")
proteomics_df   <- read.csv(proteomics_file, stringsAsFactors = FALSE)
proteomics_df$pvalue <- rank(proteomics_df$p1, ties.method = "first") * proteomics_df$p1 / nrow(proteomics_df)

# --- Airway (RNA-seq) ---
data("airway", package = "airway")
dds   <- DESeqDataSet(se = airway, design = ~ cell + dex) %>% DESeq()
deRes <- as.data.frame(results(dds))   # has pvalue & baseMean
airway_ok <- deRes %>% filter(!is.na(pvalue), !is.na(baseMean))

# --- Bottomly (RNA-seq) ---
bottomly <- analyze_dataset("bottomly")
bottomly_ok <- tibble(pvalue = bottomly$pvalue, baseMean = bottomly$baseMean) %>%
  filter(!is.na(pvalue), !is.na(baseMean))

# Put into common list
ds_list <- list(
  proteomics = list(p = proteomics_df$pvalue, x = proteomics_df$X..peptides),
  airway     = list(p = airway_ok$pvalue,     x = airway_ok$baseMean),
  bottomly   = list(p = bottomly_ok$pvalue,   x = bottomly_ok$baseMean)
)

## ==================== Settings ======================
alpha <- 0.10
nbins_for <- function(dataset) if (dataset == "proteomics") 2 else "auto"

out_dir <- "ihw_weight_plots"
dir.create(out_dir, showWarnings = FALSE)

## ========== Helpers: make ADMM plot match IHW style ==========
# Build a data.frame like IHW's plot_weights() expects:
# columns fold (factor), stratum (ordinal bin id), weight
admm_weights_df <- function(ihw_res_binning) {
  map_list       <- ihw_res_binning$map_list
  ws_mat         <- ihw_res_binning$ws_mat
  fold_lambda_ix <- ihw_res_binning$fold_lambdas_idx

  out <- lapply(seq_along(fold_lambda_ix), function(fold) {
    lambda_idx    <- fold_lambda_ix[fold]
    map_mat       <- map_list[[fold]]
    group_mapping <- map_mat[, lambda_idx]        # original -> mapped id
    weights_vec   <- ws_mat[[fold]][[lambda_idx]] # weights indexed by mapped id
    weight_final  <- weights_vec[group_mapping]   # back to original stratum order

    data.frame(
      fold    = factor(fold),
      stratum = seq_along(weight_final),
      weight  = as.numeric(weight_final),
      stringsAsFactors = FALSE
    )
  })
  do.call(rbind, out)
}

# ADMM plot (same visual style as IHW:::plot for ordinal scale)
plot_admm_like_ihw <- function(ihw_res_binning) {
  df <- admm_weights_df(ihw_res_binning)
  ggplot(df, aes(x = stratum, y = weight, col = fold)) +
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = scales::pretty_breaks()) +
    labs(x = "stratum", y = "weight", color = "fold") +
    theme(panel.grid.minor = element_blank(),
          legend.position = "none")   # hide legend for cleaner panel
}

# Old IHW plot, restyled to match (grey theme, no legend)
style_old_plot <- function(g) {
  g +
    labs(x = "stratum", y = "weight") +
    theme(panel.grid.minor = element_blank(),
          legend.position = "none",
          plot.title = element_blank())
}

## ================ Run both methods & plot ====================
run_and_plot_weights <- function(dataset, p, x) {
  nb <- nbins_for(dataset)
  message("Running methods for ", dataset, " (nbins = ", nb, ")")

  # ADMM binning (with internals for weights viz)
  ihw_res_binning <- ihw_binning_admm(
    p, x, alpha,
    nbins = "auto", nfolds_internal = 4L, nfolds = 5L,
    return_internal = TRUE
  )
  g_bin <- plot_admm_like_ihw(ihw_res_binning)

  # Old IHW (built-in plot) and re-style
  ihw_res_old <- IHWold:::ihwOld(
    p, x, alpha,
    nbins = nb, nfolds_internal = 4L, nsplits_internal = 5L
  )
  g_old <- style_old_plot(IHW:::plot(ihw_res_old))

  # save individual plots (optional)
  ggsave(file.path(out_dir, paste0(dataset, "_weights_binning_admm.png")),
         g_bin, width = 6.2, height = 4.0, dpi = 300)
  ggsave(file.path(out_dir, paste0(dataset, "_weights_oldIHW.png")),
         g_old, width = 6.2, height = 4.0, dpi = 300)

  list(binning_plot = g_bin, old_plot = g_old,
       binning_fit = ihw_res_binning, old_fit = ihw_res_old)
}

# Run for all datasets
plots_out <- lapply(names(ds_list), function(dname) {
  run_and_plot_weights(dname, ds_list[[dname]]$p, ds_list[[dname]]$x)
})
names(plots_out) <- names(ds_list)
```

```{r}
## ================ Build the 2×3 aligned panel =================
ds_order <- c("proteomics", "airway", "bottomly")

row1_bin <- lapply(ds_order, function(d) plots_out[[d]]$binning_plot)
row2_old <- lapply(ds_order, function(d) plots_out[[d]]$old_plot)

# Column headers (outside subplots)
col_head <- plot_grid(
  ggdraw() + draw_label("proteomics", fontface = "bold", size = 15),
  ggdraw() + draw_label("airway",     fontface = "bold", size = 15),
  ggdraw() + draw_label("bottomly",   fontface = "bold", size = 15),
  nrow = 1
)
```

```{r}
# Aligned rows (same sizes across columns)
row1 <- plot_grid(plotlist = row1_bin, nrow = 1, align = "hv", axis = "tblr")
row2 <- plot_grid(plotlist = row2_old, nrow = 1, align = "hv", axis = "tblr")

# Row headers + stack
panel <- plot_grid(
  col_head,
  plot_grid(ggdraw() + draw_label("IHW Binning ADMM", fontface = "bold", size = 13),
            row1, ncol = 1, rel_heights = c(0.08, 1)),
  plot_grid(ggdraw() + draw_label("Old IHW",          fontface = "bold", size = 13),
            row2, ncol = 1, rel_heights = c(0.08, 1)),
  ncol = 1, rel_heights = c(0.12, 1, 1)
)
```

```{r}
## =============== Add a shared legend (fold / stratum) ===============
# Take legend from any ADMM-style plot (they all share the same mapping)
legend_plot <- plot_admm_like_ihw(plots_out[[ds_order[1]]]$binning_fit) +
  theme(legend.position = "right") +
  guides(colour = guide_legend(title = "fold (stratum)"))  # legend title

legend_shared <- cowplot::get_legend(legend_plot)

# Attach legend to the right
panel_with_legend <- cowplot::plot_grid(panel, legend_shared,
                                        rel_widths = c(1, 0.18))

# Save
ggsave(file.path(out_dir, "weights_panel_2x3_with_legend.png"),
       panel_with_legend, width = 12, height = 6.5, dpi = 300)

```

```{r}
panel_with_legend
```